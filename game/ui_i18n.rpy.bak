init -4 python:
    
    displayStrings = object()
    
    def switch_language(target):
        global displayStrings, gm_exit_to, s_scenes, save_name, act_names, np_current_language, _window_subtitle
        if target in available_languages:
            persistent.current_language = target
            np_current_language = target
            displayStrings = displayDict[target]
            s_scenes = make_s_scenes(target)
            act_names = displayStrings.act_names
            save_name = last_scene_label
            _window_subtitle = displayStrings.window_name
            named_config()
            initialize_prefs()
            define_characters()
            if last_visited_label:
                gm_exit_to = wrap_label(last_visited_label)
        return True
    
    def make_s_scenes(lang):
        if lang == master_language:
            return displayDict[master_language].s_scenes
        
        new_s_scenes = []
        for scene in displayDict[master_language].s_scenes:
            breakflag = False
            for langscene in displayDict[lang].s_scenes:
                if scene[1] == langscene[1]:
                    new_s_scenes.append(langscene)
                    breakflag = True
                    break
            if not breakflag:
                new_s_scenes.append(scene)
        return new_s_scenes
    
    def init_language(lang):
        if lang == master_language:
            store.displayDict[lang] = object()
            return
        import copy
        store.displayDict[lang] = copy.deepcopy(displayDict[master_language])
        store.available_languages.append(lang)

    # This is the language that contains the most information
    master_language = "en"
    
    available_languages = [master_language]
    
    if not persistent.current_language:
        persistent.current_language = master_language
    
    #fonts
    mainfont = "playtime.ttf"
    titlefont = mainfont
    interfacefont = mainfont
    srsfont = "gentium.ttf"
    jpfont = "mikachan.ttf"
    
    # container class for various UI strings. Yes, I am aware of config.translations.
    # Note that changing these may or may not be a good idea; sometimes the layout isn't flexible enough.
    
    displayDict = {}
    
    
    
init -2 python:
    ## TEST LANGUAGES
    # JAPANESE (just a stub for testing)
    
    init_language("jp")
    
    def jpw(string):
        return "{font=" + jpfont + "}" + string + "{/font} "
        
    displayDict["jp"].styleoverrides = {"font": jpfont, 
                                        "language": "eastasian",
                                        "line_spacing": 5}
    
    displayDict["jp"].quote_outer_open = u"「"
    displayDict["jp"].quote_outer_close = u"」"
    displayDict["jp"].quote_inner_open = u"『"
    displayDict["jp"].quote_inner_close = u"』"
    
    displayDict["jp"].window_name = u"かたわ少女"

    displayDict["jp"].activeLanguage = jpw(u"日本語")
    displayDict["jp"].allLanguages = {}
    displayDict["jp"].allLanguages["en"] = jpw(u"英語")
    displayDict["jp"].allLanguages["de"] = jpw(u"ドイツ語")
    displayDict["jp"].allLanguages["it"] = jpw(u"イタリア語")
    displayDict["jp"].allLanguages["jp"] = displayDict["jp"].activeLanguage
    
    displayDict["jp"].return_button_text = jpw(u"戻る")
    
    displayDict["jp"].config_language_caption = jpw(u"構成") + " > " + jpw(u"言語選択")

    displayDict["jp"].name_hi = u"寿勇"


    displayDict["jp"].s_scenes = ()
    
    ##END TEST LANGUAGES

    # Master switch
    ### language-relevant config

    def named_config():

        config.file_entry_format = "%(time)s // "+displayStrings.play_time_label+": %(playtime)s\n%(save_name)s"

        config.time_format = displayStrings.timeformat
        config.menu_window_subtitle = displayStrings.window_name

        # The contents of the main menu.
        config.main_menu = [
            ( displayStrings.main_menu_start, ui.jumps("start_from_mm", "game_main_transition"), 'True'),
            ( displayStrings.main_menu_load, ui.jumps("load_screen", "main_game_transition"), 'renpy.list_saved_games()' ),
            ( displayStrings.main_menu_extra, ui.jumps("extra_from_mm"), 'get_available_scenes() or get_available_music() or get_available_images()'),
            ( displayStrings.main_menu_config, ui.jumps("prefs_screen", "main_game_transition"), 'True' ),
            ( displayStrings.main_menu_quit, ui.jumps("softquit"), 'True' ),
            ]

        # contents, game menu, etc.
        config.game_menu = [
           ( "return", displayStrings.game_menu_return, ui.jumps("_return"), 'True'),
           ( "gm_image", displayStrings.game_menu_show, ui.jumps("gm_image"), 'True'),
           ( "gm_image", displayStrings.game_menu_history,  ui.jumps("text_history_gm", "intra_transition"), 'True'), 
           ( "skipping", displayStrings.game_menu_skip, ui.jumps("_return_skipping"), 'config.allow_skipping and not renpy.context().main_menu'),
           ( "automode", displayStrings.game_menu_auto, ui.jumps("afm_on"), 'True'),
           ( "prefs", displayStrings.game_menu_config, ui.jumps("prefs_screen", "intra_transition"), 'True' ),
           ( "save", displayStrings.game_menu_save, ui.jumps("save_screen", "intra_transition"), 'playthroughflag and not renpy.context().main_menu' ),
           ( "load", displayStrings.game_menu_load, ui.jumps("load_screen", "intra_transition"), 'renpy.list_saved_games()'),
           ( "mainmenu", displayStrings.game_menu_main, ui.jumps("confirm_mm", "intra_transition"), 'not renpy.context().main_menu' ),
           ( "quit", displayStrings.game_menu_quit, ui.jumps("confirm_quit", "intra_transition"), 'True' ),
           ]

        config.joystick_keys = [
            (displayStrings.joy_left, 'joy_left'),
            (displayStrings.joy_right, 'joy_right'),
            (displayStrings.joy_up, 'joy_up'),
            (displayStrings.joy_down, 'joy_down'),
            (displayStrings.joy_dismiss, 'joy_dismiss'),
            (displayStrings.joy_rollback, 'joy_rollback'),
            (displayStrings.joy_holdskip, 'joy_holdskip'),
            (displayStrings.joy_toggleskip, 'joy_toggleskip'),
            (displayStrings.joy_hide, 'joy_hide'),
            (displayStrings.joy_menu, 'joy_menu'),
            ]


init 5 python:

    switch_language(persistent.current_language)


### common / to be implemented from here on

init 3 python:

    ex_m_tracks = (("Afternoon", music_tranquil),
                   ("Ah Eh I Oh You", music_nurse),
                   ("Air Guitar", music_soothing),
                   ("Another Day", music_another),
                   ("Cold Iron", music_tragic),
                   ("Concord", music_lilly),
                   ("Daylight", music_daily),
                   ("Generic Happy Music", music_comedy),
                   ("Painful History", music_hanako),
                   ("Happiness", music_happiness),
                   ("High Tension", music_tension),
                   ("Hokabi", music_running),
                   ("Lullaby of Open Eyes", music_serene),
                   ("Moment of Decision", music_drama),
                   ("Nocturne", music_night),
                   ("Out of the Loop", music_kenji),
                   ("Parity", music_rin),
                   ("Passing of Time", music_timeskip),
                   ("Raindrops and Puddles", music_dreamy),
                   ("Rain", music_rain),
                   ("Romance in Andante, arranged version", music_romance),
                   ("Romance in Andante, piano version", music_credits),
                   ("Sarabande from BVW1010", music_cellosolo),
                   ("School Days", music_normal),
                   ("Shadow of the Truth", music_sadness),
                   ("Standing Tall", music_emi),
                   ("Aria de l'etoile", music_twinkle),
                   ("Stride", music_pearly),
                   ("The Student Council", music_shizune),
                   ("Wiosna", music_menus),
                   ("Japanese Actually Think This is Rock", music_crappy))
                   


    # Commentary. A dictionary mapping identifier tags as they appear in the script to a tuple of title/text
    tl_notes = { "what_is_a_note": ("delta", "If you manage to make these longer than a standard text box I'm quitting."),
                 "white_blouse": ("Alpha note", "The uniform blouse will actually be white in the production art set"),
                 "Rewrite": ("Attn.", "This line has been flagged for a rewrite, or some other major change. See the following comment for details."), 
                 "Note": ("Editor Note", "This line, or word has been flagged for closer scrutiny. Not as haltingly important as a rewrite, but still worth a looksee. See following comment for details."), 
                 "LolReplace": ("Attn.", "This word, line, whichever, has been the victim of a find/replace. If this is out of context, then notify an editor, writer, or (if you have write access), do it your own damn self."),
                 "evil_smiley": ("cpl_crud", "True story. I did see someone write a smiley the other day. So gay."),
                 "ismuth_R2_friction": ("Lucky Bastard", "Damn. Just one day's worth of class on friction. I got a whole week or two's worth of friction back in high school."),
                 "ismuth_R2_impact": ("Goddamnit", "I'm beginning to think that she's doing this on purpose"),
                 "ismuth_R2_panties": ("Ed. Note", "I'm so going to quote this out of context on IRC."),
                 "ismuth_R2_strawberries": ("Editor note", "I knew it."),
                 "ismuth_R4_love": ("Editor note", "As opposed to leaving with the shirt unbuttoned and trouserless? I'm sure the ladies would l o v e that."),
                 "ismuth_R5_mechhand": ("Editor note", "I bet this guy will be an important villain in one storyline or another. I mean DAMN. A mechanical hand."),
                 "ismuth_R6_AuratoAura": ("To Aura:", "remember to add Emi inviting Hisao to this event somewhere in R1-R5, since the date has been changed a couple of times. Love, Aura"),
                 "ismuth_R8_Points": ("What?", u"No points? I feel… so… so… shortchanged…"),
                 "ismuth_R8_ART": ("What is art?", "DUN DUN DUNDUNDUN DUN DUN DUN BABY DON'T HURT ME DON'T HURT ME, NO MORE… WHAT IS ART, etc."),
                 "ismuth_R9_whut": (" " , u"…whut"),
                 "ismuth_R9_tldr": ("tl;dr", "SHRINKS R GUD"),
                 "ismuth_e14_rickroll": (" ", "Cue rickroll."),
                 "aura_raspberries": ("Aura", "If one of the editors makes a fact check and comes telling me they don't sell raspberry flavoured popsicles in Japan, I swear I am going to come to your houses at night and stab you."),
                 "qm_word": ("Milestone!", "This is officially the 250,000th word written for this game. The count is, of course, way off due to cuts and rewrites, but we celebrated it anyway.")}

